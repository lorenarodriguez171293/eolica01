<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador E√≥lico ‚Äî Producci√≥n y CO‚ÇÇ evitado</title>

<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#071022;
    --card:#0b1220;
    --accent:#1e90ff;
    --muted:#9aa6b2;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041021);color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  header{padding:18px;text-align:center;background:linear-gradient(90deg,var(--accent),#4f46e5);color:#001;box-shadow:0 6px 30px rgba(0,0,0,0.5)}
  header h1{margin:0;font-size:1.3rem}
  .wrap{max-width:1150px;margin:18px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 420px; gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.6)}
  .sim-row{display:flex;gap:12px;flex-wrap:wrap}
  .canvas-box{flex:0 0 420px;min-width:260px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#061226,#07122a);position:relative;padding:8px}
  canvas#turbineCanvas{display:block;width:100%;height:auto;background:transparent}
  .controls{flex:1;min-width:240px}
  label{display:block;font-weight:700;color:var(--muted);margin-bottom:6px;font-size:0.95rem}
  .control{margin-bottom:12px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  input[type="range"], input[type="number"], select { width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color: #e6eef8 }
  .output { margin-top:10px; padding:10px; border-radius:8px; background: rgba(0,0,0,0.4); font-weight:700; color:#e6eef8 }
  .small { font-size:0.9rem; color:var(--muted) }
  .chart-wrap{height:300px;padding:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);border:none;color:#001;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
</style>
</head>
<body>
<header>
  <h1>Simulador E√≥lico ‚Äî Producci√≥n estimada & CO‚ÇÇ evitado</h1>
</header>

<div class="wrap">
  <div class="grid">
    <!-- MAIN: simulador y controles -->
    <div class="card">
      <h2 style="margin:6px 0">üå¨Ô∏è Simulador de Parque E√≥lico</h2>
      <p class="small">Ajust√° velocidad de viento, n√∫mero de aerogeneradores, altura del hub y di√°metro del rotor. Los resultados se calculan con la f√≥rmula f√≠sica P = 0.5¬∑œÅ¬∑A¬∑v¬≥¬∑Cp (con correcciones por eficiencia y disponibilidad).</p>

      <div class="sim-row" style="margin-top:12px">
        <div class="canvas-box">
          <canvas id="turbineCanvas" width="800" height="520"></canvas>
          <div style="position:absolute;right:12px;top:12px;color:var(--muted);font-size:12px">Animaci√≥n</div>
        </div>

        <div class="controls">
          <div class="control">
            <label for="windSpeed">Velocidad de viento (m/s) ‚Äî referencia 10 m</label>
            <input id="windSpeed" type="range" min="0" max="30" step="0.1" value="8" oninput="onInputChange()">
            <input id="windSpeedNum" type="number" min="0" max="50" step="0.1" value="8" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Velocidad en 10 m; la altura del hub ajusta la velocidad efectiva mediante ley de potencia.</div>
          </div>

          <div class="control">
            <label for="hubHeight">Altura del hub (m)</label>
            <input id="hubHeight" type="range" min="20" max="180" step="1" value="80" oninput="onInputChange()">
            <input id="hubHeightNum" type="number" min="20" max="300" step="1" value="80" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Altura del eje del aerogenerador.</div>
          </div>

          <div class="control">
            <label for="rotorDiameter">Di√°metro del rotor (m)</label>
            <input id="rotorDiameter" type="range" min="20" max="220" step="1" value="120" oninput="onInputChange()">
            <input id="rotorDiameterNum" type="number" min="10" max="400" step="1" value="120" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Di√°metro de giro de las palas ‚Äî determina el √°rea barrida A = œÄ¬∑(D/2)¬≤.</div>
          </div>

          <div class="control">
            <label for="nTurbines">Cantidad de aerogeneradores</label>
            <input id="nTurbines" type="range" min="1" max="200" step="1" value="5" oninput="onInputChange()">
            <input id="nTurbinesNum" type="number" min="1" max="200" step="1" value="5" oninput="onInputChange()" style="margin-top:6px">
          </div>

          <div class="control">
            <label for="cp">Cp ‚Äî Coeficiente de potencia (Betz ‚â§ 0.59)</label>
            <input id="cp" type="range" min="20" max="50" step="1" value="38" oninput="onInputChange()">
            <input id="cpNum" type="number" min="20" max="59" step="1" value="38" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Valor t√≠pico: 30‚Äì45% (el 59% es l√≠mite te√≥rico de Betz).</div>
          </div>

          <div class="control">
            <label for="efficiency">Eficiencia del generador / p√©rdidas (%)</label>
            <input id="efficiency" type="range" min="60" max="98" step="1" value="92" oninput="onInputChange()">
            <input id="efficiencyNum" type="number" min="60" max="99" step="1" value="92" oninput="onInputChange()" style="margin-top:6px">
          </div>

          <div class="control">
            <label for="availability">Factor operativo / disponibilidad (%)</label>
            <input id="availability" type="range" min="50" max="99" step="1" value="95" oninput="onInputChange()">
            <input id="availabilityNum" type="number" min="50" max="99" step="1" value="95" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Porcentaje de tiempo que el parque est√° operando (mantenimiento, fallas, etc.).</div>
          </div>

          <div class="control">
            <label for="co2Factor">Factor de emisi√≥n evitada (kg CO‚ÇÇ / kWh)</label>
            <input id="co2Factor" type="range" min="0" max="1" step="0.01" value="0.45" oninput="onInputChange()">
            <input id="co2FactorNum" type="number" min="0" max="5" step="0.01" value="0.45" oninput="onInputChange()" style="margin-top:6px">
            <div class="small">Valor por defecto 0.45 kgCO‚ÇÇ/kWh (ajustable seg√∫n mix el√©ctrico local).</div>
          </div>

          <div style="margin-top:8px" class="row">
            <button class="btn" onclick="resetDefaults()">Restablecer valores</button>
            <button class="btn" onclick="downloadCSV()">Descargar CSV (mensual)</button>
          </div>

        </div>
      </div>

      <div style="margin-top:14px" class="output" id="resultsBox">
        C√°lculos: Potencia instant√°nea: -- MW ¬∑ Producci√≥n diaria: -- kWh ¬∑ mensual: -- kWh ¬∑ anual: -- kWh ¬∑ CO‚ÇÇ evitado anual: -- t
      </div>

      <div style="margin-top:12px" class="card chart-wrap">
        <canvas id="monthlyChart"></canvas>
      </div>

    </div>

    <!-- SIDE: explicaciones y resumen -->
    <aside class="card">
      <h3 style="margin:6px 0">‚ÑπÔ∏è C√≥mo se calcula</h3>
      <div class="small">
        <ul>
          <li><strong>Potencia instant√°nea por turbina</strong>: P = 0.5 ¬∑ œÅ ¬∑ A ¬∑ v¬≥ ¬∑ Cp ¬∑ Œ∑ (W). Donde œÅ=1.225 kg/m¬≥ (aire), A = œÄ¬∑(D/2)¬≤ (m¬≤), v = velocidad del viento (m/s), Cp = coeficiente de potencia (fracci√≥n), Œ∑ = eficiencia del generador (fracci√≥n).</li>
          <li><strong>Producci√≥n</strong>: asumimos la velocidad constante para estimar d√≠a/mes/a√±o con disponibilidad operativa.</li>
          <li><strong>CO‚ÇÇ evitado</strong>: energ√≠a (kWh) ¬∑ factor de emisi√≥n (kgCO‚ÇÇ/kWh).</li>
        </ul>
      </div>

      <h4 style="margin-top:12px">Valores r√°pidos</h4>
      <div id="quickValues" class="small">
        Potencia por turbina: -- kW<br>
        Potencia total (instant): -- kW<br>
        Producci√≥n diaria (total): -- kWh
      </div>
    </aside>
  </div>

  <footer>Simulador educativo ‚Äî resultados aproximados (no para dise√±o de ingenier√≠a).</footer>
</div>

<script>
/* ---------------------------
   Utilidades y elementos
   --------------------------- */
const el = id => document.getElementById(id);

// inputs (pairs)
const inputs = [
  ['windSpeed','windSpeedNum'],
  ['hubHeight','hubHeightNum'],
  ['rotorDiameter','rotorDiameterNum'],
  ['nTurbines','nTurbinesNum'],
  ['cp','cpNum'],
  ['efficiency','efficiencyNum'],
  ['availability','availabilityNum'],
  ['co2Factor','co2FactorNum']
];

// sync sliders <-> number fields
inputs.forEach(([a,b])=>{
  const sa = el(a), sb = el(b);
  sa.addEventListener('input', ()=>{ if(sb.value!==sa.value) sb.value = sa.value; onInputChange(); });
  sb.addEventListener('input', ()=>{ if(sa.value!==sb.value) sa.value = sb.value; onInputChange(); });
});

/* defaults */
function resetDefaults(){
  el('windSpeed').value = el('windSpeedNum').value = 8;
  el('hubHeight').value = el('hubHeightNum').value = 80;
  el('rotorDiameter').value = el('rotorDiameterNum').value = 120;
  el('nTurbines').value = el('nTurbinesNum').value = 5;
  el('cp').value = el('cpNum').value = 38;
  el('efficiency').value = el('efficiencyNum').value = 92;
  el('availability').value = el('availabilityNum').value = 95;
  el('co2Factor').value = el('co2FactorNum').value = 0.45;
  onInputChange();
}

/* ---------------------------
   Physics & calculations
   --------------------------- */

/*
 Assumptions & notes:
 - Air density rho = 1.225 kg/m^3 (standard sea level)
 - Cp from slider is given as percent (e.g., 38 -> 0.38)
 - Efficiency is generator+losses in percent
 - Availability is percent of time operational
 - Wind shear: we treat windSpeed input as reference at 10 m.
   We estimate wind at hub height using power law: v(h) = v_ref * (h / h_ref)^alpha,
   with h_ref = 10 m, alpha = 0.14 (typical for open terrain). User can treat windSpeed as measured at hub if desired.
 - Monthly days use standard month lengths.
*/

const rho = 1.225;
const h_ref = 10;
const alpha_default = 0.14; // wind shear exponent (surface roughness dependent)
const daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];

function windAtHeight(v_ref, h, alpha=alpha_default){
  // v_ref at h_ref (10 m). Compute v at hub height h.
  if(h <= 0) return v_ref;
  const v = v_ref * Math.pow((h / h_ref), alpha);
  return v;
}

// P = 0.5 * rho * A * v^3 * Cp * eta  (Watts)
function powerPerTurbine_W(v, D, Cp_frac, eta_frac){
  const A = Math.PI * Math.pow(D/2, 2); // m^2
  const P = 0.5 * rho * A * Math.pow(v, 3) * Cp_frac * eta_frac;
  return P;
}

/* ---------------------------
   Chart setup (monthly)
   --------------------------- */
const chartCtx = document.getElementById('monthlyChart').getContext('2d');
const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const monthlyChart = new Chart(chartCtx, {
  type: 'bar',
  data: {
    labels: months,
    datasets: [{
      label: 'Producci√≥n estimada (kWh/mes)',
      data: Array(12).fill(0),
      backgroundColor: 'rgba(30,144,255,0.7)',
      borderColor: 'rgba(30,144,255,1)',
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { beginAtZero: true, title: { display:true, text:'kWh' } }
    },
    plugins: {
      tooltip: { callbacks: { label: ctx => `${ctx.formattedValue} kWh` } },
      legend: { display: false }
    }
  }
});

/* ---------------------------
   Turbine animation (Canvas)
   --------------------------- */
const canvas = document.getElementById('turbineCanvas');
const ctx = canvas.getContext('2d');
let deviceRatio = window.devicePixelRatio || 1;
function resizeCanvasToDisplaySize(){
  const rect = canvas.getBoundingClientRect();
  const w = rect.width;
  const h = Math.max(300, rect.height);
  canvas.width = Math.floor(w * deviceRatio);
  canvas.height = Math.floor(h * deviceRatio);
  canvas.style.height = h + 'px';
  ctx.setTransform(deviceRatio, 0, 0, deviceRatio, 0, 0);
}
window.addEventListener('resize', ()=>{ resizeCanvasToDisplaySize(); drawFrame(); });

resizeCanvasToDisplaySize();

/* turbine drawing parameters */
let animId = null;
let rotorAngle = 0;

// simple function to draw a single turbine (hub + blades) at center
function drawTurbine(x,y,hubHeightPx, Dpx, angle, bladeColor='#fff', towerColor='#dfe6f1'){
  // tower
  ctx.fillStyle = towerColor;
  const towerTopY = y - hubHeightPx;
  ctx.beginPath();
  ctx.moveTo(x-6, y);
  ctx.lineTo(x+6, y);
  ctx.lineTo(x+2, towerTopY);
  ctx.lineTo(x-2, towerTopY);
  ctx.closePath();
  ctx.fill();

  // nacelle
  ctx.fillStyle = '#e6eef8';
  ctx.fillRect(x-18, towerTopY-8, 36, 14);

  // hub circle
  ctx.save();
  ctx.translate(x, towerTopY);
  ctx.rotate(angle);
  // blades
  ctx.fillStyle = bladeColor;
  for(let i=0;i<3;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.quadraticCurveTo(Dpx*0.15, -Dpx*0.05, Dpx*0.5, -Dpx*0.07);
    ctx.quadraticCurveTo(Dpx*0.45, Dpx*0.12, 4, 6);
    ctx.fill();
    ctx.rotate(Math.PI*2/3);
  }
  // hub center
  ctx.fillStyle = '#ffdf5d';
  ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

// background scene
function drawScene(totalTurbines, hubHeight_m, rotorDiameter_m, rotorRPM_est){
  // clear
  const W = canvas.width/deviceRatio, H = canvas.height/deviceRatio;
  ctx.clearRect(0,0,W,H);

  // sky gradient
  const sky = ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#8fbff7');
  sky.addColorStop(1,'#071b2a');
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,W,H);

  // ground
  ctx.fillStyle = '#0b2a16';
  ctx.fillRect(0, H*0.8, W, H*0.2);

  // a simple horizon line
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.beginPath(); ctx.moveTo(0,H*0.8); ctx.lineTo(W,H*0.8); ctx.stroke();

  // place turbines across width
  const spacing = Math.max(120, W / Math.max(1,totalTurbines+1));
  const baseY = H*0.8;
  const centerXStart = spacing;
  // convert physical hub height (m) to pixel height for drawing (scale)
  // choose scale so that 200 m -> 200 px approx
  const pxPerMeter = 1.4; // visual scale
  const hubHeightPx = Math.max(40, hubHeight_m * pxPerMeter);

  // rotor diameter in px
  const Dpx = Math.max(30, rotorDiameter_m * 0.4);

  for(let i=0;i<totalTurbines;i++){
    const x = centerXStart + i*spacing;
    drawTurbine(x, baseY, hubHeightPx, Dpx, rotorAngle);
  }

  // add some info overlay
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.fillRect(10, 10, 260, 86);
  ctx.fillStyle = '#e6eef8';
  ctx.font = '13px Inter, Arial';
  ctx.fillText(`Velocidad a 10 m: ${Number(el('windSpeed').value).toFixed(2)} m/s`, 18, 32);
  ctx.fillText(`Velocidad en hub: ${Number(currentHubWindSpeed).toFixed(2)} m/s`, 18, 52);
  ctx.fillText(`N√∫mero turbinas: ${totalTurbines}`, 18, 72);
  ctx.fillText(`Di√°metro rotor: ${rotorDiameter_m} m`, 18, 92);
}

/* animation loop */
let lastTime = performance.now();
let currentHubWindSpeed = Number(el('windSpeed').value);
function animate(time){
  const dt = (time - lastTime)/1000; lastTime = time;
  // rotor angle increment depends on rotor tip speed ~ proportional to wind speed.
  // We'll compute rotational angular speed proportional to v/hypot factor:
  const v = currentHubWindSpeed;
  // approximate relationship: RPM ~ k * v / D, choose k to look good
  const D = Number(el('rotorDiameter').value);
  const k = 12; // tuning constant
  const rpm = (k * v / Math.max(1,D)); // crude rpm
  const omega = rpm * 2*Math.PI / 60; // rad/s
  rotorAngle += omega * dt;

  // draw
  const n = Number(el('nTurbines').value);
  const hubH = Number(el('hubHeight').value);
  const Dm = Number(el('rotorDiameter').value);
  drawScene(n, hubH, Dm, rpm);

  animId = requestAnimationFrame(animate);
}
animId = requestAnimationFrame(animate);

/* ---------------------------
   Main update: calculations & chart
   --------------------------- */

function onInputChange(){
  // read inputs (already synced by event listeners)
  const v_ref = Number(el('windSpeed').value); // at 10 m
  const hubH = Number(el('hubHeight').value);
  currentHubWindSpeed = windAtHeight(v_ref, hubH);
  const D = Number(el('rotorDiameter').value);
  const n = Number(el('nTurbines').value);
  const Cp = Number(el('cp').value) / 100.0;
  const eff = Number(el('efficiency').value) / 100.0;
  const avail = Number(el('availability').value) / 100.0;
  const co2f = Number(el('co2Factor').value);

  // Instantaneous power per turbine (W)
  const P_turbine_W = powerPerTurbine_W(currentHubWindSpeed, D, Cp, eff);
  // total instantaneous power (W)
  const P_total_W = P_turbine_W * n;

  // Convert W -> kW and kW -> kWh/day etc.
  const P_total_kW = P_total_W / 1000.0;

  // daily energy assuming constant wind speed and availability factor:
  const daily_kWh = P_total_kW * 24 * avail;
  const monthly_kWh = daysInMonth.map(d => daily_kWh * d); // array per month
  const annual_kWh = daily_kWh * 365;

  // CO2 avoided: kg CO2 = energy_kWh * factor (kg/kWh)
  const co2_annual_kg = annual_kWh * co2f;
  const co2_annual_t = co2_annual_kg / 1000.0;

  // update results box
  el('resultsBox').innerText = `Potencia instant√°nea: ${(P_total_W/1e6).toFixed(3)} MW ¬∑ Producci√≥n diaria: ${daily_kWh.toFixed(0)} kWh ¬∑ mensual (promedio): ${(annual_kWh/12).toFixed(0)} kWh ¬∑ anual: ${annual_kWh.toFixed(0)} kWh ¬∑ CO‚ÇÇ evitado anual: ${co2_annual_t.toFixed(2)} t`;

  // quick values
  el('quickValues').innerHTML = `Potencia por turbina: ${(P_turbine_W/1000).toFixed(1)} kW<br>Potencia total (instant): ${P_total_kW.toFixed(1)} kW<br>Producci√≥n diaria (total): ${daily_kWh.toFixed(0)} kWh`;

  // update monthly chart
  monthlyChart.data.datasets[0].data = monthly_kWh.map(v => Number(v.toFixed(0)));
  monthlyChart.update('none');
}

// initialize with defaults
resetDefaults();

/* ---------------------------
   CSV export (monthly)
   --------------------------- */
function downloadCSV(){
  // create rows: Month, Days, kWh
  const v_ref = Number(el('windSpeed').value);
  const hubH = Number(el('hubHeight').value);
  currentHubWindSpeed = windAtHeight(v_ref, hubH);
  const D = Number(el('rotorDiameter').value);
  const n = Number(el('nTurbines').value);
  const Cp = Number(el('cp').value) / 100.0;
  const eff = Number(el('efficiency').value) / 100.0;
  const avail = Number(el('availability').value) / 100.0;
  const P_turbine_W = powerPerTurbine_W(currentHubWindSpeed, D, Cp, eff);
  const P_total_kW = (P_turbine_W * n) / 1000.0;
  const daily_kWh = P_total_kW * 24 * avail;

  const rows = [['Mes','Dias','Producci√≥n (kWh)']];
  for(let i=0;i<12;i++){
    const val = daily_kWh * daysInMonth[i];
    rows.push([months[i], daysInMonth[i], Math.round(val)]);
  }
  // CSV text
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'produccion_eolica_mensual.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ---------------------------
   Helper: keep chart responsive when container resizes
   --------------------------- */
const observer = new ResizeObserver(()=>{ monthlyChart.resize(); });
observer.observe(document.querySelector('.chart-wrap'));

/* expose for console */
window.onInputChange = onInputChange;
window.resetDefaults = resetDefaults;
window.downloadCSV = downloadCSV;
</script>
</body>
</html>
